<!doctype html>
<html>
	<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="referrer" content="no-referrer">

	<title>Shout</title>

	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/style.css">
	<link id="theme" rel="stylesheet" href="<%= theme %>">

	<link rel="shortcut icon" href="/img/favicon.png">
	<link rel="icon" sizes="192x192" href="/img/touch-icon-192x192.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png">

	<script src="js/libs/libwebphone/kazoo.js"></script>

	</head>
	<body class="<%= public ? "public" : "" %>">

	<div id="wrap">
	<div id="viewport">
		<aside id="sidebar" class="tse-scrollable">
			<div class="tse-content">
				<div class="networks"></div>
				<div class="empty">
					You're not connected to any networks yet.
				</div>
			</div>
		</aside>
		
		<div class="kazoo-dialer">
			<div id="loginForm" class="demo-block" style="display: none;">
				<form>
					Private Identity: <input type="text" id="privateIdentity" value="user_sel656"><br>
					Public Identity: <input type="text" id="publicIdentity" value="sip:user_sel656@webdev.realm"><br>
					Password: <input type="text" id="password" value="adoe8aurmjex"><br>
					<!-- Private Identity: <input type="text" id="privateIdentity" value="user_9hgggnp4dp"><br>
					Public Identity: <input type="text" id="publicIdentity" value="sip:user_9hgggnp4dp@webdev.realm"><br>
					Password: <input type="text" id="password" value="3pgje9y2br9u"><br> -->
					<!-- Private Identity: <input type="text" id="privateIdentity" value="user_s6chaxxdu8"><br>
					Public Identity: <input type="text" id="publicIdentity" value="sip:user_s6chaxxdu8@webdev.realm"><br>
					Password: <input type="text" id="password" value="v8pcb2bg27hb"><br> -->
					Realm: <input type="text" id="realm" value="webdev.realm"><br>
					<button id="btnLogin" type="button" onClick="login()">Login</button>
					<button id="btnLogout" type="button" onClick="logout()" style="display: none;">Log out</button>
				</form>
			</div>

			<div id="divLoggedIn" class="demo-block" style="display: none;">
				Logged In
				<div>
					<input type="text" id="destination" placeholder="sip:2222@webdev.realm" value="sip:9009@webdev.realm"></input>
					<button id="call" onClick="call()">Call</button>
				</div>
			</div>

			<div id="divCalling" class="demo-block" style="display: none;">
				<h3>Call in progress...</h3>

				<button id="btnHangup" type="button" onClick="hangup()">Hangup</button>
				<button id="btnMute" type="button" onClick="mute()" data-state="unmuted">Mute</button>

				<div id="dialpad">
					<table>
						<tr>
							<td><input type="button" value="1" onClick="sendDTMF('1')"/></td>
							<td><input type="button" value="2" onClick="sendDTMF('2')"/></td>
							<td><input type="button" value="3" onClick="sendDTMF('3')"/></td>
						</tr>
						<tr>
							<td><input type="button" value="4" onClick="sendDTMF('4')"/></td>
							<td><input type="button" value="5" onClick="sendDTMF('5')"/></td>
							<td><input type="button" value="6" onClick="sendDTMF('6')"/></td>
						</tr>
						<tr>
							<td><input type="button" value="7" onClick="sendDTMF('7')"/></td>
							<td><input type="button" value="8" onClick="sendDTMF('8')"/></td>
							<td><input type="button" value="9" onClick="sendDTMF('9')"/></td>
						</tr>
						<tr>
							<td><input type="button" value="*" onClick="sendDTMF('*')"/></td>
							<td><input type="button" value="0" onClick="sendDTMF('0')"/></td>
							<td><input type="button" value="#" onClick="sendDTMF('#')"/></td>
						</tr>
					</table>
				</div>

				<div id="transferDiv">
					<input type="text" id="transferDestination" placeholder="sip:2222@webdev.realm"></input>
					<button id="transfer" onClick="transfer()">Transfer</button>
				</div>
			</div>

			<div id="toast" onClick="clearToast()" onMouseOver="clearTimeout(toastTimer)" onMouseOut="clearToast(3000)"></div>

			<div id="popupOverlay"></div>
			<div id="popup">
				<div id="popupHeader"></div>
				<div id="popupContent"></div>
				<div id="popupActions">
					<button id="popupOkBtn">OK</button>
					<button id="popupCancelBtn">Cancel</button>
				</div>
			</div>

			<div id="flash_div">
			</div>

			<script>
				var paramsInit = {
					forceRTMP: false,
					flashContainer: 'flash_div',
					onLoaded: function() {
						document.getElementById('loginForm').style.display = "block";
					},
					onFlashMissing: function(container) {
						container.innerHTML = 'This content requires the Adobe Flash Player. <a href=http://www.adobe.com/go/getflash/>Get Flash</a>';
						container.className = 'demo-flash-error';
					}
				};
				kazoo.init(paramsInit);
				function login(){
					var kazooParams = {
						version: 'sipjs',
						wsUrl: 'ws://'+document.getElementById('realm').value+':8080',
						rtmpUrl: 'rtmp://'+document.getElementById('realm').value+'/sip',
						realm: document.getElementById('realm').value,
						privateIdentity: document.getElementById('privateIdentity').value,
						publicIdentity: document.getElementById('publicIdentity').value,
						password: document.getElementById('password').value,
						onAccepted: onAccepted,
						onConnected: onConnected,
						onHangup: onHangup,
						onCancel: onCancel,
						onIncoming: onIncoming,
						onConnecting: onConnecting,
						onTransfer: onTransfer,
						onNotified: onNotified,
						onError: onError,
						reconnectMaxAttempts: 3, // Unlimited autoreconnect attempts
						reconnectDelay: 5000 // New autoreconnect attempt every 5 seconds
					};
					kazoo.register(kazooParams);
				}
				function onTransfer() {
					document.getElementById('divCalling').style.display = "none";
				}
				function onIncoming(call) {
					console.log('onIncoming', call);
					var caller = call.callerName + (call.callerNumber ? ' ('+call.callerNumber+')' : '');
					confirmPopup(caller + ' is calling you! Pick up the call?', call.accept, call.reject);
				}
				function onConnecting() {
					console.log('Connecting...');
				}
				function onHangup() {
					document.getElementById('divCalling').style.display = "none";
				}
				function onCancel(status) {
					var msg = 'Your call has been canceled';
					if(status && status.message) { msg += ': ' + status.message; }
					if(status && status.code) { msg += ' (' + status.code + ')'; }
					toast('info', msg);
					closePopup();
				}
				function onAccepted() {
					document.getElementById('divCalling').style.display = "block";
				}
				function onConnected() {
					document.getElementById('divLoggedIn').style.display = "block";
					document.getElementById('btnLogin').style.display = "none";
					document.getElementById('btnLogout').style.display = "block";
				}
				function onNotified(notification) {
					switch(notification.key) {
						case 'replaced_registration': {
							if(document.getElementById('btnLogin').style.display === "none") { //Check to ignore double notifications
								logout();
								toast('error', notification.message);
							}
							break;
						}
						case 'transfer_notification':
						case 'overriding_registration': {
							toast('info', notification.message);
							break;
						}
						case 'connectivity_notification': {
							if(notification.status === 'offline') {
								toast('warning', notification.message);
							} else {
								toast('info', notification.message);
							}
							break;
						}
						case 'reconnecting_notification': {
							toast('info', notification.message + '('+notification.attempt+')');
							break;
						}
						default: {
							console.log(notification.message);
						}
					}
				}
				function onError(error) {
					toast('error', 'ERROR: ' + error.message);
					closePopup();
					if(error.key === 'disconnected') {
						document.getElementById('divLoggedIn').style.display = "none";
						document.getElementById('divCalling').style.display = "none";
						document.getElementById('btnLogin').style.display = "block";
						document.getElementById('btnLogout').style.display = "none";
					}
				}
				/* UI Binding */
				function transfer() {
					var destination = document.getElementById('transferDestination').value;
					kazoo.transfer(destination);
				};
				function call() {
					var destination = document.getElementById('destination').value;
					kazoo.connect(destination);
				}
				function hangup() {
					kazoo.hangup();
				}
				function mute(e) {
					var muteBtn = document.getElementById('btnMute');
					if(muteBtn.getAttribute('data-state') === 'unmuted') {
						kazoo.muteMicrophone(true, function() {
							muteBtn.setAttribute('data-state', 'muted');
							muteBtn.innerHTML = 'Unmute';
						});
					} else {
						kazoo.muteMicrophone(false, function() {
							muteBtn.setAttribute('data-state', 'unmuted');
							muteBtn.innerHTML = 'Mute';
						});
					}
				}
				function logout() {
					kazoo.logout();
					document.getElementById('divLoggedIn').style.display = "none";
					document.getElementById('divCalling').style.display = "none";
					document.getElementById('btnLogin').style.display = "block";
					document.getElementById('btnLogout').style.display = "none";
					closePopup();
				}
				function sendDTMF(dtmf) {
					kazoo.sendDTMF(dtmf);
				}
				var toastTimer;
				function toast(type, content, timer) {
					clearTimeout(toastTimer);
					var toast = document.getElementById('toast');
					toast.className = type;
					toast.innerHTML = content;
					toast.style.display = 'block';
					toastTimer = setTimeout(function() {
						toast.style.display = 'none';
					}, timer || 5000);
				}
				function clearToast(delay) {
					clearTimeout(toastTimer);
					toastTimer = setTimeout(function() {
						document.getElementById('toast').style.display = 'none';
					}, delay || 0);
				}
				function confirmPopup(message, okCallback, cancelCallback, type) {
					var popupHeader = document.getElementById('popupHeader');
					document.getElementById('popupContent').innerHTML = message || "Confirm?";
					document.getElementById('popupOverlay').style.display = 'block';
					document.getElementById('popup').style.display = 'block';
					popupHeader.className = type || 'info';
					popupHeader.innerHTML = 'Confirm';
					document.getElementById('popupOkBtn').onclick = function() {
						closePopup();
						okCallback && okCallback();
					};
					document.getElementById('popupCancelBtn').onclick = function() {
						closePopup();
						cancelCallback && cancelCallback();
					};
				}
				function closePopup() {
					document.getElementById('popupOverlay').style.display = 'none';
					document.getElementById('popup').style.display = 'none';
					document.getElementById('popupContent').innerHTML = '';
					document.getElementById('popupOkBtn').onclick = function() {};
					document.getElementById('popupCancelBtn').onclick = function() {};
				}
			</script>
		</div>
		
		<footer id="footer">
			<button class="icon sign-in" data-target="#sign-in" data-title="Sign in" data-placement="top" title="Sign in to Shout"></button>
			<button class="icon connect" data-target="#connect" data-title="Connect" data-placement="top" title="Connect to network"></button>
			<button class="icon settings" data-target="#settings" data-title="Settings" data-placement="top" title="Client settings"></button>
			<button id="sign-out" class="icon sign-out" data-placement="top" title="Sign out"></button>
		</footer>
		<div id="main">
			<div id="windows">
				<div id="chat" class="no-colors"></div>
				<div id="sign-in" data-title="Sign in" class="window">
					<div class="header">
						<button class="lt"></button>
					</div>
					<form class="container" action="">
						<div class="row">
							<div class="col-xs-12">
								<h1 class="title">Sign in</h1>
							</div>
							<div class="col-xs-12">
								<label>
								Username
								<input class="input" name="user">
								</label>
							</div>
							<div class="col-xs-12">
								<label class="port">
								Password
								<input class="input" type="password" name="password">
								</label>
							</div>
							<div class="col-xs-12">
								<label class="remember">
									<input type="checkbox" name="remember" checked="checked">
									Stay signed in
								</label>
							</div>
							<div class="col-xs-12 error" style="display: none;">
								Authentication failed.
							</div>
							<div class="col-xs-12">
								<button type="submit" class="btn">
									Sign in
								</button>
							</div>
						</div>
					</form>
				</div>
				<div id="connect" data-title="Connect" class="window">
					<div class="header">
						<button class="lt"></button>
					</div>
					<form class="container" action="">
						<div class="row">
							<div class="col-sm-12">
								<h1 class="title">Connect</h1>
							</div>
							<div <%= typeof(displayNetwork) !== "undefined" && !displayNetwork ? 'style="display: none;"' : ''%>>
								<div class="col-sm-12">
									<h2>Network settings</h2>
								</div>
								<div class="col-sm-3">
								<label>Name</label>
									</div>
								<div class="col-sm-9">
									<input class="input" name="name" value="<%= defaults.name %>">
								</div>
								<div class="col-sm-3">
									<label>Server</label>
								</div>
								<div class="col-sm-6 col-xs-8">
									<input class="input" name="host" value="<%= defaults.host %>">
								</div>
								<div class="col-sm-3 col-xs-4">
									<div class="port">
										<input class="input" name="port" value="<%= defaults.port %>">
									</div>
								</div>
								<div class="clearfix"></div>
								<div class="col-sm-3">
									<label>Password</label>
								</div>
								<div class="col-sm-9">
									<input class="input" type="password" name="password" value="<%= defaults.password %>">
								</div>
								<div class="col-sm-3"></div>
								<div class="col-sm-9">
									<label class="tls">
										<input type="checkbox" name="tls" <%= defaults.tls ? 'checked="checked"' : '' %>>
										Enable TLS/SSL
									</label>
								</div>
								<div class="clearfix"></div>
							</div>
							<div class="col-sm-12">
								<h2>User preferences</h2>
							</div>
							<div class="col-sm-3">
								<label>Nick</label>
							</div>
							<div class="col-sm-5">
								<input class="input nick" name="nick" value="<%= defaults.nick %>">
							</div>
							<div class="clearfix"></div>
							<div class="col-sm-3">
								<label>Username</label>
							</div>
							<div class="col-sm-5">
								<input class="input username" name="username" value="<%= defaults.username %>">
							</div>
							<div class="clearfix"></div>
							<div class="col-sm-3">
								<label>Real name</label>
							</div>
							<div class="col-sm-9">
								<input class="input" name="realname" class="input" value="<%= defaults.realname %>">
							</div>
							<div class="col-sm-3">
								<label>Channels</label>
							</div>
							<div class="col-sm-9">
								<input class="input" name="join" class="input" value="<%= defaults.join %>">
							</div>
							<div class="col-sm-3 clearfix"></div>
							<div class="col-sm-9">
								<button type="submit" class="btn">
									Connect
								</button>
							</div>
						</div>
					</form>
				</div>
				<div id="settings" data-title="Settings" class="window">
					<div class="header">
						<button class="lt"></button>
					</div>
					<div class="container">
						<div class="row">
							<div class="col-sm-12">
								<h1 class="title">Settings</h1>
							</div>
							<div class="col-sm-12">
								<h2>Messages</h2>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="join">
									Show joins
								</label>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="motd">
									Show motd
								</label>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="part">
									Show parts
								</label>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="nick">
									Show nick changes
								</label>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="mode">
									Show mode
								</label>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="quit">
									Show quits
								</label>
							</div>
							<div class="col-sm-12">
								<h2>Visual Aids</h2>
							</div>
							<div class="col-sm-12">
								<label class="opt">
									<input type="checkbox" name="colors">
									Enable colored nicknames
								</label>
							</div>
							<% if (typeof prefetch === "undefined" || prefetch !== false) { %>
							<div class="col-sm-12">
								<h2>Links and URLs</h2>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="thumbnails">
									Auto-expand thumbnails
								</label>
							</div>
							<div class="col-sm-6">
								<label class="opt">
									<input type="checkbox" name="links">
									Auto-expand links
								</label>
							</div>
							<% } %>
							<div class="col-sm-12">
								<h2>Notifications</h2>
							</div>
							<div class="col-sm-12">
								<label class="opt">
								<input id="badge" type="checkbox" name="badge">
								Enable badge
								</label>
							</div>
							<div class="col-sm-12">
								<label class="opt">
								<input type="checkbox" name="notification">
								Enable notification sound
								</label>
							</div>
							<div class="col-sm-12">
								<div class="opt">
									<button id="play">Play sound</button>
								</div>
							</div>

							<div class="col-sm-12">
								<label class="opt">
									<input type="checkbox" name="notifyAllMessages">
									Enable notification for all messages
								</label>
							</div>
							<div class="col-sm-12">
								<h2>About Shout</h2>
							</div>
							<div class="col-sm-12">
								<p class="about">
									You're currently running version <small><%= version %></small><br>
									<a href="https://raw.githubusercontent.com/busseyl/shout/master/CHANGELOG.md" target="_blank">Check for updates</a>
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
			<form id="form" action="">
				<div class="inner">
					<button id="submit" type="submit">
						Send
					</button>
					<div class="input">
						<label for="input" id="nick"></label>
						<input id="input" class="mousetrap">
					</div>
				</div>
			</form>
		</div>
	</div>
	</div>

	<script src="js/libs.min.js"></script>
	<script src="js/shout.templates.js"></script>
	<script src="js/shout.js"></script>

	</body>
</html>
